---
layout: post
title: 'java安全机制其实有点不安全'
date: 2007-03-17 19:58
comments: true
tags: ['java','service','class']
---

看下面的这段代码，摘自《Java Examples in a Nutsbell》（java实例技术手册）：

就是一个简单的通用的多线程服务器

这个例子可以通过配置参数：

java je3.net.Server -control www 3333 je3.net.Server$HTTPMirror 5555

来启动，然后再ie中输入： [ http://localhost:5555 ](http://localhost:5555) 就可以看到效果。

写一个policy文件放在同根目录下：叫server.policy

grant{  
permission java.net.SocketPermission "*:1024-4444","connect,accept";  
permission java.io.FilePermission "E://workspace//j2ee1.3//-", "read";  
};

下面加上jvm虚拟机参数

java -Djava.security.manager -Djava.security.policy=server.policy

je3.net.Server -control www 3333 je3.net.Server$HTTPMirror 5555再次启动。

按道理，本不应该启动。因为端口5555并没有得到连接许可。但是很可惜输入 [ http://localhost:5555
](http://localhost:5555) 还是可以看到结果。因为在java的sdk中暗含了java.policy文件。那就把它改为-
Djava.security.policy==server.policy应该就可以了。结果跑不了了。原因就在policy文件中的permission
java.net.SocketPermission "*:1024-4444","connect,accept"; 其实，我一直不太清楚listen
，accept，connect的区别在什么地方。但是这里的例子说明你只用permission java.net.SocketPermission "*:10
24-4444","listen";就可以了。端口该闭的就闭了。如果用accept和connect反而没有什么用。不知道java的安全性高在什么地方。因为j
ava.policy文件中从1024以上的端口全都使用了listen。所以以后要配置端口时一定要注意。

![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedBloc
kStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/
ContractedBlock.gif) /**/  /*  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* Copyright (c) 2004 David Flanagan.  All rights reserved.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This code is from the book Java Examples in a Nutshell, 3nd Edition.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* It is provided AS-IS, WITHOUT ANY WARRANTY either expressed or implied.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* You may study, use, and modify it for any non-commercial purpose,  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* including teaching and use in open-source projects.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* You may distribute it non-commercially as long as you retain this notice.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* For a commercial use license, or to purchase the book,  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* please visit  http://www.davidflanagan.com/javaexamples3.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedBloc
kEnd.gif) */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
package  je3.net;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
import  java.io.  *  ;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
import  java.net.  *  ;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
import  java.util.  *  ;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)
import  java.util.logging.  *  ;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedBloc
kStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/
ContractedBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This class is a generic framework for a flexible, multi-threaded server.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* It listens on any number of specified ports, and, when it receives a  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* connection on a port, passes input and output streams to a specified Service  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* object which provides the actual service.  It can limit the number of  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* concurrent connections, and logs activity to a specified stream.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedBloc
kEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedBloc
kStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/
ContractedBlock.gif) public  class  Server  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* A main() method for running the server as a standalone program.  The  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* command-line arguments to the program should be pairs of servicenames  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* and port numbers.  For each pair, the program will dynamically load the  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* named Service class, instantiate it, and tell the server to provide  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* that Service on the specified port.  The special -control argument  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* should be followed by a password and port, and will start special  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* server control service running on the specified port, protected by the  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* specified password.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  static  void  main(String[] args)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) try  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
if  (args.length  < 2  )  //  Check number of arguments  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
throw  new  IllegalArgumentException(  "  Must specify a service  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Create a server object that has a limit of 10 concurrent  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  connections, and logs to a Logger at the Level.INFO level  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Prior to Java 1.4 we did this: new Server(System.out, 10);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Server s  =  new  Server(Logger.getLogger(Server.  class  .getName()),  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Level.INFO,  10  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Parse the argument list  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
int  i  =  0  ;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) while  (i  < args.length)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) if  (args[i].equals(  "  -control  "  ))  ...  {
//  Handle the -control arg  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
i  ++  ;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
String password  =  args[i  ++  ];  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
int  port  =  Integer.parseInt(args[i  ++  ]);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  add control service  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
s.addService(  new  Control(s, password), port);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) else  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Otherwise start a named service on the specified port.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Dynamically load and instantiate a Service class  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
String serviceName  =  args[i  ++  ];  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Class serviceClass  =  Class.forName(serviceName);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Service service  =  (Service)serviceClass.newInstance();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
int  port  =  Integer.parseInt(args[i  ++  ]);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
s.addService(service, port);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) catch  (Exception e)  ...  {  //  Display a message
if anything goes wrong  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
System.err.println(  "  Server:  "  \+  e);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
System.err.println(  "  Usage: java Server  "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  [-control <password> <port>]  "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  [<servicename> <port> ... ]  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
System.exit(  1  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  This is the state for the server  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Map services;  //  Hashtable mapping ports to Listeners  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Set connections;  //  The set of current connections  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
int  maxConnections;  //  The concurrent connection limit  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
ThreadGroup threadGroup;  //  The threadgroup for all our threads  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  This class was originally written to send logging output to a stream.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  It has been retrofitted to also support the java.util.logging API of  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Java 1.4.  You can use either, neither, or both.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
PrintWriter logStream;  //  Where we send our logging output to  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Logger logger;  //  A Java 1.4 logging destination  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Level logLevel;  //  the level to log messages at  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This is the Server() constructor.  It must be passed a stream  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* to send log output to (may be null), and the limit on the number of  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* concurrent connections.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  Server(OutputStream logStream,  int
maxConnections)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
this  (maxConnections);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
setLogStream(logStream);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
log(  "  Starting server  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This constructor added to support logging with the Java 1.4 Logger class  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  Server(Logger logger, Level logLevel,  int
maxConnections)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
this  (maxConnections);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
setLogger(logger, logLevel);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
log(  "  Starting server  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This constructor supports no logging  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  Server(  int  maxConnections)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
threadGroup  =  new  ThreadGroup(Server.  class  .getName());  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
this  .maxConnections  =  maxConnections;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
services  =  new  HashMap();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
connections  =  new  HashSet(maxConnections);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* A public method to set the current logging stream.  Pass null  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* to turn logging off.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  synchronized  void
setLogStream(OutputStream out)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
if  (out  !=  null  ) logStream  =  new  PrintWriter(out);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
else  logStream  =  null  ;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* Set the current Logger and logging level. Pass null to turn logging off.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  synchronized  void  setLogger(Logger
logger, Level level)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
this  .logger  =  logger;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
this  .logLevel  =  level;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  Write the specified string to the log
*/  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) protected  synchronized  void  log(String s)  ...
{  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
if  (logger  !=  null  ) logger.log(logLevel, s);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) if  (logStream  !=  null  )  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
logStream.println(  "  [  "  \+  new  Date()  \+  "  ]  "  \+  s);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
logStream.flush();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  Write the specified object to the log
*/  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) protected  void  log(Object o)  ...  {
log(o.toString()); }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This method makes the server start providing a new service.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* It runs the specified Service object on the specified port.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
public  synchronized  void  addService(Service service,  int  port)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
throws  IOException  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Integer key  =  new  Integer(port);  //  the hashtable key  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Check whether a service is already on that port  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
if  (services.get(key)  !=  null  )  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
throw  new  IllegalArgumentException(  "  Port  "  \+  port  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  already in use.  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Create a Listener object to listen for connections on the port  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Listener listener  =  new  Listener(threadGroup, port, service);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Store it in the hashtable  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
services.put(key, listener);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Log it  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
log(  "  Starting service  "  \+  service.getClass().getName()  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  on port  "  \+  port);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Start the listener running.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
listener.start();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This method makes the server stop providing a service on a port.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* It does not terminate any pending connections to that service, merely  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* causes the server to stop accepting new connections  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  synchronized  void  removeService(  int
port)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Integer key  =  new  Integer(port);  //  hashtable key  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Look up the Listener object for the port in the hashtable  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
final  Listener listener  =  (Listener) services.get(key);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
if  (listener  ==  null  )  return  ;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Ask the listener to stop  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
listener.pleaseStop();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Remove it from the hashtable  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
services.remove(key);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  And log it.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
log(  "  Stopping service  "  \+  listener.service.getClass().getName()  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  on port  "  \+  port);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This nested Thread subclass is a "listener".  It listens for  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* connections on a specified port (using a ServerSocket) and when it gets  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* a connection request, it calls the servers addConnection() method to  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* accept (or reject) the connection.  There is one Listener for each  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* Service being provided by the Server.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  class  Listener  extends  Thread  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
ServerSocket listen_socket;  //  The socket to listen for connections  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
int  port;  //  The port we're listening on  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Service service;  //  The service to provide on that port  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
volatile  boolean  stop  =  false  ;  //  Whether we've been asked to stop  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* The Listener constructor creates a thread for itself in the  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* threadgroup.  It creates a ServerSocket to listen for connections  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* on the specified port.  It arranges for the ServerSocket to be  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* interruptible, so that services can be removed from the server.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
public  Listener(ThreadGroup group,  int  port, Service service)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
throws  IOException  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
super  (group,  "  Listener:  "  \+  port);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
listen_socket  =  new  ServerSocket(port);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  give it a non-zero timeout so accept() can be interrupted  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
listen_socket.setSoTimeout(  5000  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
this  .port  =  port;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
this  .service  =  service;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This is the polite way to get a Listener to stop accepting  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* connections  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) **  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  void  pleaseStop()  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
this  .stop  =  true  ;  //  Set the stop flag  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
this  .interrupt();  //  Stop blocking in accept()  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) try  ...  { listen_socket.close(); }  //  Stop
listening.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) catch  (IOException e)  ...  {}  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* A Listener is a Thread, and this is its body.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* Wait for connection requests, accept them, and pass the socket on  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* to the addConnection method of the server.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  void  run()  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) while  (  !  stop)  ...  {  //  loop until we're
asked to stop.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) try  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Socket client  =  listen_socket.accept();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
addConnection(client, service);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) catch  (InterruptedIOException e)  ...  {}  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) catch  (IOException e)  ...  {log(e);}  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This is the method that Listener objects call when they accept a  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* connection from a client.  It either creates a Connection object  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* for the connection and adds it to the list of current connections,  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* or, if the limit on connections has been reached, it closes the  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* connection.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) protected  synchronized  void  addConnection(Socket
s, Service service)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  If the connection limit has been reached  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) if  (connections.size()  >=  maxConnections)  ...
{  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) try  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Then tell the client it is being rejected.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
PrintWriter out  =  new  PrintWriter(s.getOutputStream());  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  Connection refused;  "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  the server is busy; please try again later.  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.flush();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  And close the connection to the rejected client.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
s.close();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  And log it, of course  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
log(  "  Connection refused to  "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
s.getInetAddress().getHostAddress()  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  :  "  \+  s.getPort()  \+  "  : max connections reached.  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) }  catch  (IOException e)  ...  {log(e);}  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) else  ...  {  //  Otherwise, if the limit has not
been reached  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Create a Connection thread to handle this connection  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Connection c  =  new  Connection(s, service);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Add it to the list of current connections  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
connections.add(c);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Log this new connection  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
log(  "  Connected to  "  \+  s.getInetAddress().getHostAddress()  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  :  "  \+  s.getPort()  \+  "  on port  "  \+  s.getLocalPort()  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  for service  "  \+  service.getClass().getName());  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  And start the Connection thread to provide the service  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
c.start();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* A Connection thread calls this method just before it exits.  It removes  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* the specified Connection from the set of connections.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) protected  synchronized  void
endConnection(Connection c)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
connections.remove(c);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
log(  "  Connection to  "  \+  c.client.getInetAddress().getHostAddress()  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  :  "  \+  c.client.getPort()  \+  "  closed.  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  Change the current connection limit
*/  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  synchronized  void  setMaxConnections(  int
max)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
maxConnections  =  max;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This method displays status information about the server on the  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* specified stream.  It can be used for debugging, and is used by the  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* Control service later in this example.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  synchronized  void
displayStatus(PrintWriter out)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Display a list of all Services that are being provided  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Iterator keys  =  services.keySet().iterator();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) while  (keys.hasNext())  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Integer port  =  (Integer) keys.next();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Listener listener  =  (Listener) services.get(port);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  SERVICE  "  \+  listener.service.getClass().getName()  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
\+  "  ON PORT  "  \+  port  \+  "  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Display the current connection limit  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  MAX CONNECTIONS:  "  \+  maxConnections  \+  "  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Display a list of all current connections  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Iterator conns  =  connections.iterator();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) while  (conns.hasNext())  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Connection c  =  (Connection)conns.next();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  CONNECTED TO  "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
c.client.getInetAddress().getHostAddress()  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  :  "  \+  c.client.getPort()  \+  "  ON PORT  "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
c.client.getLocalPort()  \+  "  FOR SERVICE  "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
c.service.getClass().getName()  \+  "  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This class is a subclass of Thread that handles an individual  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* connection between a client and a Service provided by this server.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* Because each such connection has a thread of its own, each Service can  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* have multiple connections pending at once.  Despite all the other  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* threads in use, this is the key feature that makes this a  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* multi-threaded server implementation.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  class  Connection  extends  Thread  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Socket client;  //  The socket to talk to the client through  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Service service;  //  The service being provided to that client  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This constructor just saves some state and calls the superclass  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* constructor to create a thread to handle the connection.  Connection  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* objects are created by Listener threads.  These threads are part of  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* the server's ThreadGroup, so all Connection threads are part of that  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* group, too.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  Connection(Socket client, Service service)
...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
super  (  "  Server.Connection:  "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
client.getInetAddress().getHostAddress()  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  :  "  \+  client.getPort());  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
this  .client  =  client;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
this  .service  =  service;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This is the body of each and every Connection thread.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* All it does is pass the client input and output streams to the  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* serve() method of the specified Service object.  That method is  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* responsible for reading from and writing to those streams to  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* provide the actual service.  Recall that the Service object has  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* been passed from the Server.addService() method to a Listener  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* object to the addConnection() method to this Connection object, and  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* is now finally being used to provide the service.  Note that just  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* before this thread exits it always calls the endConnection() method  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* to remove itself from the set of connections  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  void  run()  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) try  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
InputStream in  =  client.getInputStream();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
OutputStream out  =  client.getOutputStream();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
service.serve(in, out);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) catch  (IOException e)  ...  {log(e);}  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) finally  ...  { endConnection(  this  ); }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* Here is the Service interface that we have seen so much of.  It defines  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* only a single method which is invoked to provide the service.  serve()  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* will be passed an input stream and an output stream to the client.  It  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* should do whatever it wants with them, and should close them before  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* returning.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
*  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* All connections through the same port to this service share a single  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* Service object.  Thus, any state local to an individual connection must  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* be stored in local variables within the serve() method.  State that  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* should be global to all connections on the same port should be stored  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* in instance variables of the Service class.  If the same Service is  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* running on more than one port, there will typically be different  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* Service instances for each port.  Data that should be global to all  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* connections on any port should be stored in static variables.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
*  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* Note that implementations of this interface must have a no-argument  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* constructor if they are to be dynamically instantiated by the main()  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* method of the Server class.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  interface  Service  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
public  void  serve(InputStream in, OutputStream out)  throws  IOException;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* A very simple service.  It displays the current time on the server  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* to the client, and closes the connection.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  static  class  Time  implements  Service
...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  void  serve(InputStream i, OutputStream o)
throws  IOException  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
PrintWriter out  =  new  PrintWriter(o);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  new  Date()  \+  "  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.close();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
i.close();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This is another example service.  It reads lines of input from the  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* client, and sends them back, reversed.  It also displays a welcome  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* message and instructions, and closes the connection when the user  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* enters a '.' on a line by itself.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  static  class  Reverse  implements  Service
...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  void  serve(InputStream i, OutputStream o)
throws  IOException  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
BufferedReader in  =  new  BufferedReader(  new  InputStreamReader(i));  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
PrintWriter out  =  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
new  PrintWriter(  new  BufferedWriter(  new  OutputStreamWriter(o)));  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  Welcome to the line reversal server.  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  Enter lines.  End with a '.' on a line by itself.  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) for  (;;)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  > "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.flush();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
String line  =  in.readLine();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
if  ((line  ==  null  )  ||  line.equals(  "  .  "  ))  break  ;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
for  (  int  j  =  line.length()  \-  1  ; j  >=  0  ; j  \--  )  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(line.charAt(j));  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.close();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
in.close();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This service is an HTTP mirror, just like the HttpMirror class  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* implemented earlier in this chapter.  It echos back the client's  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* HTTP request  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  static  class  HTTPMirror  implements
Service  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  void  serve(InputStream i, OutputStream o)
throws  IOException  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
BufferedReader in  =  new  BufferedReader(  new  InputStreamReader(i));  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
PrintWriter out  =  new  PrintWriter(o);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  HTTP/1.0 200  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  Content-Type: text/plain  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
String line;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) while  ((line  =  in.readLine())  !=  null  )  ...
{  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
if  (line.length()  ==  0  )  break  ;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(line  \+  "  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.close();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
in.close();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This service demonstrates how to maintain state across connections by  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* saving it in instance variables and using synchronized access to those  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* variables.  It maintains a count of how many clients have connected and  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* tells each client what number it is  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  static  class  UniqueID  implements
Service  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
public  int  id  =  0  ;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  synchronized  int  nextId()  ...  {  return
id  ++  ; }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  void  serve(InputStream i, OutputStream o)
throws  IOException  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
PrintWriter out  =  new  PrintWriter(o);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  You are client #:  "  \+  nextId()  \+  "  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.close();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
i.close();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This is a non-trivial service.  It implements a command-based protocol  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* that gives password-protected runtime control over the operation of the  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* server.  See the main() method of the Server class to see how this  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* service is started.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
*  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* The recognized commands are:  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
*   password: give password; authorization is required for most commands  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
*   add:      dynamically add a named service on a specified port  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
*   remove:   dynamically remove the service running on a specified port  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
*   max:      change the current maximum connection limit.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
*   status:   display current services, connections, and connection limit  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
*   help:     display a help message  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
*   quit:     disconnect  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
*  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This service displays a prompt, and sends all of its output to the user  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* in capital letters.  Only one client is allowed to connect to this  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* service at a time.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  static  class  Control  implements  Service
...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Server server;  //  The server we control  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
String password;  //  The password we require  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
boolean  connected  =  false  ;  //  Whether a client is already connected  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* Create a new Control service.  It will control the specified Server  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* object, and will require the specified password for authorization  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* Note that this Service does not have a no argument constructor,  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* which means that it cannot be dynamically instantiated and added as  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* the other, generic services above can be.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  Control(Server server, String password)
...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
this  .server  =  server;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
this  .password  =  password;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) /** */  /**  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* This is the serve method that provides the service.  It reads a  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* line the client, and uses java.util.StringTokenizer to parse it  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* into commands and arguments.  It does various things depending on  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
* the command.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) *  */  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) public  void  serve(InputStream i, OutputStream o)
throws  IOException  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Setup the streams  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
BufferedReader in  =  new  BufferedReader(  new  InputStreamReader(i));  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
PrintWriter out  =  new  PrintWriter(o);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
String line;  //  For reading client input lines  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Has the user has given the password yet?  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
boolean  authorized  =  false  ;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  If there is already a client connected to this service, display  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  a message to this client and close the connection.  We use a  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  synchronized block to prevent a race condition.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) synchronized  (  this  )  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) if  (connected)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  ONLY ONE CONTROL CONNECTION ALLOWED.  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.close();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
return  ;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
else  connected  =  true  ;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  This is the main loop: read a command, parse it, and handle it  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) for  (;;)  ...  {  //  infinite loop  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  > "  );  //  Display a prompt  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.flush();  //  Make it appear right away  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
line  =  in.readLine();  //  Get the user's input  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
if  (line  ==  null  )  break  ;  //  Quit if we get EOF.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) try  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Use a StringTokenizer to parse the user's command  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
StringTokenizer t  =  new  StringTokenizer(line);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
if  (  !  t.hasMoreTokens())  continue  ;  //  if input was empty  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Get first word of the input and convert to lower case  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
String command  =  t.nextToken().toLowerCase();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Now compare to each of the possible commands, doing the  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  appropriate thing for each command  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) if  (command.equals(  "  password  "  ))  ...  {
//  Password command  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
String p  =  t.nextToken();  //  Get the next word  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) if  (p.equals(  this  .password))  ...  {  //  Is
it the password?  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  OK  "  );  //  Say so  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
authorized  =  true  ;  //  Grant authorization  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
else  out.print(  "  INVALID PASSWORD  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) else  if  (command.equals(  "  add  "  ))  ...  {
//  Add Service command  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Check whether password has been given  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
if  (  !  authorized) out.print(  "  PASSWORD REQUIRED  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) else  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Get the name of the service and try to  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  dynamically load and instantiate it.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Exceptions will be handled below  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
String serviceName  =  t.nextToken();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Class serviceClass  =  Class.forName(serviceName);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
Service service;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) try  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
service  =  (Service)serviceClass.newInstance();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) catch  (NoSuchMethodError e)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
throw  new  IllegalArgumentException(  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  Service must have a  "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  no-argument constructor  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
int  port  =  Integer.parseInt(t.nextToken());  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  If no exceptions occurred, add the service  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
server.addService(service, port);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  SERVICE ADDED  "  );  //  acknowledge  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) else  if  (command.equals(  "  remove  "  ))  ...
{  //  Remove service  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
if  (  !  authorized) out.print(  "  PASSWORD REQUIRED  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) else  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
int  port  =  Integer.parseInt(t.nextToken());  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
server.removeService(port);  //  remove the service  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  SERVICE REMOVED  "  );  //  acknowledge  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) else  if  (command.equals(  "  max  "  ))  ...  {
//  Set connection limit  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
if  (  !  authorized) out.print(  "  PASSWORD REQUIRED  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) else  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
int  max  =  Integer.parseInt(t.nextToken());  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
server.setMaxConnections(max);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  MAX CONNECTIONS CHANGED  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) else  if  (command.equals(  "  status  "  ))  ...
{  //  Status Display  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
if  (  !  authorized) out.print(  "  PASSWORD REQUIRED  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
else  server.displayStatus(out);  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) else  if  (command.equals(  "  help  "  ))  ...  {
//  Help command  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Display command syntax.  Password not required  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  COMMANDS:  "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  password <password> "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  add <service> <port> "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  remove <port> "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  max <max-connections> "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  status  "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  help  "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
"  quit  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
else  if  (command.equals(  "  quit  "  ))  break  ;  //  Quit command.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
else  out.print(  "  UNRECOGNIZED COMMAND  "  );  //  Error  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockStart.gif) ![](http://images.csdn.net/syntaxhighlighting/OutliningIndicato
rs/ContractedSubBlock.gif) catch  (Exception e)  ...  {  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  If an exception occurred during the command, print an  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  error message, then output details of the exception.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.print(  "  ERROR WHILE PARSING OR EXECUTING COMMAND:  "  \+  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
e  \+  "  "  );  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  Finally, when the loop command loop ends, close the streams  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  and set our connected flag to false so that other clients can  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
//  now connect.  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
connected  =  false  ;  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
out.close();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/InBlock.gif)
in.close();  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedSubB
lockEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/ExpandedBloc
kEnd.gif) }  
![](http://images.csdn.net/syntaxhighlighting/OutliningIndicators/None.gif)

